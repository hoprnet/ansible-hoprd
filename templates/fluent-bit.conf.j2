[SERVICE]
    Daemon Off
    Flush 1
    Log_Level info
    Parsers_File /fluent-bit/etc/parsers.conf
    HTTP_Server On
    HTTP_Listen 0.0.0.0
    HTTP_Port 2020
    Health_Check On
[INPUT]
    Name        tail
    Path        /var/lib/docker/containers/*/*.log
    Parser      docker
    Tag         docker.*
    DB          /var/log/fluent-bit-k8s-container.db
    Mem_Buf_Limit 20MB
    Skip_Long_Lines On

# Remove stream and time keys
[FILTER]
    Name        record_modifier
    Match       docker.*
    Remove_Key  stream
    Remove_Key  time

# Parser filter as JSON object from json_log attribute
[FILTER]
    Name         parser
    Match        docker.*
    Key_Name     log
    Parser       json
    Reserve_Data On

# Filter by logs emitted by hoprd containers only
[FILTER]
    Name   grep
    Match  docker.*
    Regex  threadId .*

# Extract hoprd custom fields using prefix field_*
[FILTER]
    Name nest
    Match docker.*
    Operation lift
    Add_prefix field_
    Nested_under fields

# Exclude empty messages
[FILTER]
    Name         grep
    Match        docker.*
    Regex        field_message .+

# Extract span fields using prefix span_*
[FILTER]
    Name nest
    Match docker.*
    Operation lift
    Add_prefix span_
    Nested_under span

# Truncate message to 250 characters
[FILTER]
    Name   lua
    Match  docker.*
    Script /fluent-bit/scripts/truncate.lua  
    Call   truncate_message

# Flatten spans array
[FILTER]
    Name   lua
    Match  docker.*
    Script /fluent-bit/scripts/flatten_spans.lua
    Call   flatten_spans_fields

# Rename fields
[FILTER]
    Name    modify
    Match   docker.*
    Add     namespace {{ hoprd_namespace }}
    Add     hoprd_node_name {{ hoprd_node_name }}
    Add     docker_image_tag {{ hoprd_version }}
    Add     label_instance {{ hoprd_node_name }}
    Add     label_network {{ hoprd_network }}
    Add     label_peerId {{ hoprd_peer_id }}
    Add     label_nativeAddress {{ hoprd_native_address }}
    Rename  level severity
    Remove  spans

[OUTPUT]
    Name                gelf
    Match               docker.*
    Host                {{ hoprd_fluentbit_graylog_host }}
    Port                12201
    Mode                tcp
    Gelf_Timestamp_Key  date
    tls                 On
    tls.verify          On
    tls.debug           4
    tls.ca_file         /fluent-bit/ssl/ca.crt
    tls.crt_file        /fluent-bit/ssl/tls.crt
    tls.key_file        /fluent-bit/ssl/tls.key

# [OUTPUT]
#    Name       stdout
#    Match      docker.*
